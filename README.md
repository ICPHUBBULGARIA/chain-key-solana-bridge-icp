# galactic_bridge_icp

### Deployment
Deploys ledger and minter

```bash
dfx start --background

./scripts/export.sh
./scripts/deploy_all.sh
```

### (Re)Generating candid file (minter.did)
```bash
./scripts/did.sh
```

# Flow examples

### Sol to ckSol
```
┌────┐ ┌───────────────┐           ┌──────────┐┌──────────┐
│User│ │Solana Contract│           │  Minter  ││  Ledger  │
└─┬──┘ └───────┬───────┘           └────┬─────┘└─────┬────┘
  │            │                        │            │
  │   deposit  │                        │            │
  │───────────>│                        │            │
  │            │   scraps transactions  │            │
  │            │<───────────────────────│            │
  │            │                        │ on deposit │
  │            │                        │ mint asset │
  │            │                        │───────────>│
  │            │                        │            │
┌─┴──┐ ┌───────┴───────┐           ┌────┴─────┐┌─────┴────┐
│User│ │Solana Contract│           │  Minter  ││  Ledger  │
└────┘ └───────────────┘           └──────────┘└──────────┘
```

### ckSol to Sol
```
 ┌───────────────┐ ┌────┐             ┌──────────┐┌──────────┐
 │Solana Contract│ │User│             │  Minter  ││  Ledger  │
 └─┬─────────────┘ └─┬──┘             └────┬─────┘└─────┬────┘
   │                 │                     │            │
   │                 │ give "icrc2_approve" to minter   │
   │                 │─────────────────────────────────>│
   │                 │                     │            │
   │                 │ burn                │            │
   │                 │────────────────────>│transfer_from
   │                 │                     │───────────>│
   │                 │ generate coupon     │            │
   │                 │<────────────────────│            │
   │  withdraw       │                     │            │
   │<────────────────│                     │            │
   │                 │                     │            │
 ┌─┴─────────────┐ ┌─┴──┐             ┌────┴─────┐┌─────┴────┐
 │Solana Contract│ │User│             │  Minter  ││  Ledger  │
 └───────────────┘ └────┘             └──────────┘└──────────┘
```

# Coupon holds message(address to receive asset, amount, etc.), signature and public address and is used to release SOL from solana contract


### Help

## get_address
Returns Threshold ECDSA address ("ecdsa_public_key") in 3 formats:
1) compressed public key (size: 33 bytes, generated from icp)
2) uncompressed public key (size: 64 bytes, generated from compressed version via "libsecp256k1" library)
3) ethereum address (size: 20 bytes)

```bash
dfx canister call minter get_address
```

## sign message
Signs a predefined message with "sign_with_ecdsa":
```
    let coupon = Coupon {
        address: "0xb12B5e756A894775FC32EDdf3314Bb1B1944dC34".to_string(),
        amount: 10_000_000_000_000_000_000,
    };
```

Returns:
1) coupon in json format
2) hex of coupon
3) signature

```bash
dfx canister call minter sign
```

## verify
Verifies if the signature matches the message and is generated by the key pair (via "k256" library).

Example:
```bash
dfx canister call minter verify \
  '("ff7c9fd9cd985cc026f41a598b35f8f5216262fcfbc4f73d194aec2111d9510524d75a56334f09bfa06cd059341f69f4f0336b34d3d24c9e4378f8f37ebcf16b", "{\"address\":\"0xb12B5e756A894775FC32EDdf3314Bb1B1944dC34\",\"amount\":10000000000000000000}", "03727f6da716f126f2d0363eea95f968e44898336a3778405b1b3c2eb6c107f439")'
```

## y_parity / recovery id
Returns recovery id generated by signature, message and public key (via "k256" library).
It is 0 or 1.

```bash
dfx canister call minter y_parity \
  '("eff9f22408018ac1f73cf59662f3f51f732c0e9daa21b6ba479b852317563fb62b66d3284f0c7a29dcaaf52c69e27c6df1680d1afa62d96f3786c3ec79627ffa", "{\"address\":\"0xb12B5e756A894775FC32EDdf3314Bb1B1944dC34\",\"amount\":10000000000000000000}", "0367c358de3b815816756d6f2cb0520ca22b660b282de8e599de83a2b4bb2f60ab")'

```

## get_ledger_id

```
dfx canister call minter get_ledger_id
```

## mint

```bash
dfx canister call minter mint "(principal \"$USER_PRINCIPAL\", 1_000)"

dfx canister call ledger icrc1_balance_of "(record { owner = principal \"$USER_PRINCIPAL\" })"
```

## burn

```bash
dfx canister call ledger icrc2_approve "(record {
    spender = record { owner = principal \"$(dfx canister id minter)\" };
    amount = 1_000_000;
  })" --identity $USER_PRINCIPAL_NAME

dfx canister call minter burn "(1_000)" --identity $USER_PRINCIPAL_NAME

dfx canister call ledger icrc1_balance_of "(record { owner = principal \"$USER_PRINCIPAL\" })"

dfx canister call ledger icrc1_total_supply
```